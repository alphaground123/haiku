<!DOCTYPE html>  <html> <head>   <title>site.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="haiku.html">                 haiku.js               </a>                                           <a class="source" href="cli.html">                 cli.js               </a>                                           <a class="source" href="collection.html">                 collection.js               </a>                                           <a class="source" href="logger.html">                 logger.js               </a>                                           <a class="source" href="page.html">                 page.js               </a>                                           <a class="source" href="server.html">                 server.js               </a>                                           <a class="source" href="site.html">                 site.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               site.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p><strong>The Haiku site</strong> provides the main object inside Haiku. It's constructor can take several <code>options</code> which are commonly passed from command-line flags or a configuration file (also a command-line flag) when using the <code>haiku</code> commands.</p>

<p>run <code>haiku --help</code> for more details or view the inline documentation for the cli for more details.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Require modules.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">inherits</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;util&quot;</span><span class="p">).</span><span class="nx">inherits</span>
  <span class="p">,</span> <span class="nx">events</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;events&quot;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;underscore&quot;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">Logger</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;haiku/logger&quot;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">Collection</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;haiku/collection&quot;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span>
<span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h1>The Site Class</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h2>Site Constructor</h2>

<p>The <code>Site</code> constructor can take a single <code>options</code> argument. <code>options</code> is expected to be an object.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">Site</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p><code>options.root</code> is the path to the directory where Haiku will be reading
from.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">root</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">(),</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p><code>options.buildDir</code> is the root relative path to the directory where
will Haiku to build to. All compiled html, xml, site assets, etc. will
be added to this directory.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">buildDir</span><span class="o">:</span> <span class="s1">&#39;build&#39;</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p><code>options.contentDir</code> is the <strong>root relative</strong> path to the directory
where the Haiku content is, files in the content directory will be
read and converted by Haiku into your site's files. All content in this
directory must be text!</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">contentDir</span><span class="o">:</span> <span class="s1">&#39;content&#39;</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p><code>options.templatesDir</code> is the <strong>root relative</strong> path to the templates
directory, this is where haiku will lookup it's templates and layouts.
A piece of content like this:</p>

<pre><code>---
layout: default
title: Just an example
---

{{&gt;header}}

some content

{{&gt;footer}}
</code></pre>

<p>will expect a templates dir that looks like this:</p>

<pre><code>. templates
|-- layouts
|   `-- default.mustache
|-- footer.mustache
`-- header.mustache
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">templatesDir</span><span class="o">:</span> <span class="s1">&#39;templates&#39;</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p><code>options.publicDir</code> is the <strong>root relative</strong> path to the public
directory content in this directory will not be read by haiku but
instead copied or served directly, this is where you will want to place
your site's assets like stylesheets and images</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">publicDir</span><span class="o">:</span> <span class="s1">&#39;public&#39;</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p><code>options.index</code> the name of the file for haiku to use when serving
routes like <code>GET /</code> or <code>GET /posts/</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">index</span><span class="o">:</span> <span class="s1">&#39;index.html&#39;</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p><code>options.logger</code> the logger object.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">logger</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Logger</span><span class="p">({</span><span class="nx">level</span><span class="o">:</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">loglevel</span> <span class="o">||</span> <span class="s1">&#39;info&#39;</span><span class="p">)</span> <span class="p">})</span>
  <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>we're an event emitter, so make sure we call it's constructor</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Site</span><span class="p">.</span><span class="nx">super_</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>directories is the list of directories to process</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">directories</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">content</span><span class="o">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">root</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">contentDir</span><span class="p">),</span>
    <span class="nx">templates</span><span class="o">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">root</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">templatesDir</span><span class="p">),</span>
    <span class="kr">public</span><span class="o">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">root</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">publicDir</span><span class="p">)</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>the content object to map to GET /</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">index</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>who do we call to log what's going on</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">logger</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">logger</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>folder is where we keep our contents ... this helps
avoid confusion since once of the folder items is called
"content" and we also have a class Content. it also prevents
content from accidentally overwriting, say, the render method</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>both the site and collection objects have a folder associated
with them, and it can be accessed directly, ex:
site.folder["content"] or site.folder.templates</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">folder</span> <span class="o">=</span> <span class="p">{};</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>the index refers to the content we deliver for GET /
you can set this in options as options.index</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Site</span><span class="p">.</span><span class="nx">default_index</span> <span class="o">=</span> <span class="s2">&quot;index.html&quot;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>properly inherit from EventEmitter</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">inherits</span><span class="p">(</span><span class="nx">Site</span><span class="p">,</span><span class="nx">events</span><span class="p">.</span><span class="nx">EventEmitter</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>define our methods - we'll add them to the prototype below using
_.extend - just a stylistic thing to avoid having to do
Site.prototype.method = ... over and over again</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">Methods</span> <span class="o">=</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>read all the content for the site and build an object model
for it ...</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">read</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">site</span> <span class="o">=</span> <span class="k">this</span>  <span class="c1">// for callbacks</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>what collection objects do we need to build</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span>   <span class="nx">collections</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">directories</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>how many are there? helpful for checking to see if we're done</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span>   <span class="nx">size</span> <span class="o">=</span> <span class="nx">collections</span><span class="p">.</span><span class="nx">length</span>

    <span class="p">,</span>   <span class="nx">log</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">logger</span>
    <span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>check to see if all the collections are ready
basically, if we have the same number of items in our folder as we
do content directories to process, we must be finished, since we
don't store them in folders except in our callback</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">isReady</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">size</span> <span class="o">==</span> <span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">site</span><span class="p">.</span><span class="nx">folder</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span> <span class="p">};</span>

    <span class="k">try</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>okay, here we go ... for each directory that we're passed</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">_</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">directories</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_path</span><span class="p">,</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">log</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;processing &quot;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot; directory [&quot;</span> <span class="o">+</span> <span class="nx">_path</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>make sure this is a valid directory ...
collections assume you're passing in a valid directory</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">_path</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">stats</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span> <span class="p">}</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">stats</span><span class="p">.</span><span class="nx">isDirectory</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">path</span> <span class="o">+</span> <span class="s2">&quot;must be a directory.&quot;</span><span class="p">);</span>
          <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>create a new collection using this directory</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Collection</span><span class="p">({</span><span class="s2">&quot;site&quot;</span><span class="o">:</span> <span class="nx">site</span><span class="p">,</span> <span class="nx">path</span><span class="o">:</span> <span class="nx">_path</span> <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>read the collection and when we're done, invoke our callback</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">collection</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">&quot;collection &quot;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot; ready&quot;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>here's where we add it to the folder, so now our isReady
function will mark us as finished</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">site</span><span class="p">.</span><span class="nx">folder</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">collection</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>if we're the last one to finish, then we want to do some
wrap up and emit our "ready" event</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="nx">isReady</span><span class="p">())</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>first, if we have a separate public directory, we
combine it with our actual content; this way you don't
have to define separate rewrite rules or anything</p>             </td>             <td class="code">               <div class="highlight"><pre>              <span class="k">if</span> <span class="p">(</span><span class="nx">site</span><span class="p">.</span><span class="nx">folder</span><span class="p">.</span><span class="kr">public</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">site</span><span class="p">.</span><span class="nx">folder</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">folder</span><span class="p">,</span>
                      <span class="nx">site</span><span class="p">.</span><span class="nx">folder</span><span class="p">.</span><span class="kr">public</span><span class="p">.</span><span class="nx">folder</span><span class="p">);</span>
                <span class="k">delete</span> <span class="nx">site</span><span class="p">.</span><span class="nx">folder</span><span class="p">.</span><span class="kr">public</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>some shortcuts -</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">site</span><span class="p">.</span><span class="nx">content</span> <span class="o">=</span> <span class="nx">site</span><span class="p">.</span><span class="nx">folder</span><span class="p">.</span><span class="nx">content</span>
                <span class="nx">site</span><span class="p">.</span><span class="nx">templates</span> <span class="o">=</span> <span class="nx">site</span><span class="p">.</span><span class="nx">folder</span><span class="p">.</span><span class="nx">templates</span><span class="p">;</span>
                <span class="nx">site</span><span class="p">.</span><span class="nx">layouts</span> <span class="o">=</span> <span class="nx">site</span><span class="p">.</span><span class="nx">templates</span><span class="p">.</span><span class="nx">folder</span><span class="p">.</span><span class="nx">layouts</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>another shortcut, but this one takes some work because
we don't want the content objects themselves in here, we
want the template data itself. so what we do is iterate
through each content object in templates and build up a
second hash using the content object's data</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">site</span><span class="p">.</span><span class="nx">partials</span> <span class="o">=</span> <span class="nx">_</span><span class="p">(</span><span class="nx">site</span><span class="p">.</span><span class="nx">folder</span><span class="p">.</span><span class="nx">templates</span><span class="p">.</span><span class="nx">getIndex</span><span class="p">())</span>
                  <span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">partials</span><span class="p">,</span><span class="nx">value</span><span class="p">,</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">partials</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
                    <span class="k">return</span> <span class="nx">partials</span><span class="p">;</span>
                  <span class="p">},{});</span>
              <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>okay, bookkeeping is finished, and we're in the isReady()
callback here, which means we've processed all our content
directories. so we're ready as we're ever gonna be</p>             </td>             <td class="code">               <div class="highlight"><pre>              <span class="nx">site</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;ready&quot;</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">});</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// something went wrong</span>
      <span class="nx">site</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>a nice convience function that converts GET / into
whatever our index path is and then calls resolve() on
the content collection, which is where the real work
is done ...</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">resolve</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">path</span> <span class="o">||</span> <span class="nx">path</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="nx">path</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">path</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">toJSON</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span> <span class="nx">title</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">title</span> <span class="p">},</span> <span class="k">this</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">());</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>ask each collection object to build itself</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">build</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;This command has not yet been implemented.&quot;</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>don't forget to add our methods to the prototype!</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Site</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span><span class="nx">Methods</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Site</span><span class="p">;</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 